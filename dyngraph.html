<!DOCTYPE html>
<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
	<link rel="shortcut icon" type="image/jpg" href="img/favicon.ico"/>
        <title>Dynamic graph</title>
        <script src="js/main.js"></script>
        <script src="js/node.js"></script>
        <script src="js/graph.js"></script>
	<script type="text/javascript">
	  function config() {
	      for (let it in col_sels)
	       	  col_sels[it].value = colours[it];
	      inp_vals_map.sz_canvas.dispatchEvent(new Event('change'));
	      inp_vals_map.wd_line.dispatchEvent(new Event('change'));
	      inp_vals_map.nu_alpha.dispatchEvent(new Event("change"));
	      tracer.dispatchEvent(new Event('change'));
	      // document.getElementById("sel_graphalgs").value = '0'; // does not help when tabs are restored
	  }
	  function remove_unconnected() {
	      const edge_list = get_edge_list();
	      let output_string = "";
	      for(let i in edge_list) {
		  output_string += edge_list[i][0] + " " + edge_list[i][1] + "\n";
	      }
	      area_edgelist.value = output_string;
	  }
	  function set_scenario(scen,node_id="nu_nodes",edge_id="nu_edges",brch_id="nu_branches") {
	      //     nodes,  edges, branch
	      //       0       1      2
	      const scen_map = {
		  0: [true,  true,  false],
		  1: [true,  false, true ],
		  2: [true,  false, false],
		  3: [false, false, false]
	      };
	      const params = {
		  0: document.getElementById(node_id),
		  1: document.getElementById(edge_id),
		  2: document.getElementById(brch_id)
	      };
	      for( let a_key of Object.keys(params))
	       	  params[a_key].disabled = !scen_map[scen][a_key];
	  }
	  function proc_sel_graphalg(sel_id) {
	      const selg = document.getElementById(sel_id);
	      const seli = selg.selectedIndex;
	      console.log("alg selected: " + seli);
	      switch (seli) {
	      case 0:
	      case 1:
		  set_scenario(0);
		  break;
	      case 2:
	      case 5:
	      case 6:
	      case 7:
	      case 8:
	      case 9:
		  set_scenario(2);
		  break;
	      case 3:
		  set_scenario(1);
		  break;
	      case 4:
		  set_scenario(3);
		  break;
	      default:
		  console.log("Unhandled selection");
	      }
	      set_graph_alg(seli);
	  }
	  function resize_canvas(sz) {
	      canv.width = sz;
	      canv.height = sz;
	      update_scatter(inp_vals_map.nu_scatter.value);
	  }
	</script>
	<style type="text/css">
	  body {
	      font-family: helvetica,arial,sans-serif;
	  }
	  h1 {
	      text-align: center;
	  }
	  label {
	      font-size: 1.5vw;
	      vertical-align: middle;
	  }
	  input, button, select {
	      font-size: 1vw;
	      vertical-align: middle;
	  }
	  input.cb {
	      width: 1.8vw;
	      height: 1.8vh;
	  }
	  input.rb {
	      width: 2.25vw;
	      height: 2.25vh;
	  }
	  .column {
	      float: left;
	      padding: 1vw;
	  }
	  .centred {
	      margin-left: auto;
	      margin-right: auto;
	      text-align: center;
	  }
	  .right {
	      margin-left: auto;
	      margin-right: auto;
	      text-align: right;
	  }
	  .button1 {
	      width: 11rem;
	  }
	  .button2 {
	      width: 100%;
	  }
	  #canvas_space {}
	  #panel_space {}
	  body {
	      background: #27221F; /* 墨色 「すみいろ」*/
	      /* color: #EBF6F7;      /\* 藍白 「あいじろ」*\/ */
	      color: #FFDDCA;      /* 白練 「しろねり」*/
	  }
	  canvas {
	      background: #171412; /* 黒色 「こくしょく」*/
	      /* background: #181B26; /\* 褐色 「かちいろ」*\/ */
	      padding: 0;
	      margin: 0 auto;
	      margin-bottom: 1rem;
	      display: block;
	  }
	  td {
	      /* text-align: center; */
	      vertical-align: middle;
	  }
	  .slider {
	      -webkit-appearance: none;
	      width: 100%;
	      height: 1px;
	      border-radius: 5px;
	      background: #171412;
	      outline: none;
	      opacity: 0.7;
	      -webkit-transition: .2s;
	      transition: opacity .2s;
	  }
	  .slider::-webkit-slider-thumb {
	      -webkit-appearance: none;
	      appearance: none;
	      width: 20px;
	      height: 20px;
	      border-radius: 50%; 
	      background: #2A603B;
	      cursor: pointer;
	  }
	  .slider::-moz-range-thumb {
	      width: 18px;
	      height: 18px;
	      border-radius: 50%;
	      background: #2A603B;
	      cursor: pointer;
	  }
	</style>
    </head>
    <body onload="config();restart();">
      <div id="main_container">
        <div class="column" id="panel_space">
	  <table>
	    <tr>
	      <td><label>canvas</label></td>
	      <td><input id="sz_canvas" type="number" min="100" max="8192"></input></td>
	    </tr>
	    <tr>
	      <td><label>nodes</label></td>
	      <td><input id="nu_nodes" type="number" min="2" max="1000"></input></td>
	    </tr>
	    <tr>
	      <td><label>radius</label></td>
	      <td><input id="sz_radius" type="number" min="0" max="100"></input></td>
	    </tr>
	    <tr>
	      <td><label>edges</label></td>
	      <td><input id="nu_edges" type="number" min="1" max="1000"></input></td>
	    </tr>
	    <tr>
	      <td><label>line width</label></td>
	      <td><input id="wd_line" type="number" min="1" max="32"></input></td>
	    </tr>
	    <tr>
	      <td><label>branches</label></td>
	      <td><input id="nu_branches" type="number" min="1" max="10" disabled></input></td>
	    </tr>
	    <tr>
	      <td><label>scatter</label></td>
	      <td><input id="nu_scatter" type="number" min="1" max="100"></input><label>%</label></td>
	    </tr>
	    <tr>
	      <td><label>alpha</label></td>
	      <td><input id="nu_alpha" type="number" min="10" max="100"></input><label>%</label></td>
	    </tr>
	    <tr>
	      <td colspan="2">
		<table id="tbl_col_select">
		  <tr>
		    <th class="button1"></th>
		    <th>colour</th>
		    <th>random</th>
		    <th>off</th>
		  </tr>
		  <tr>
		    <td><label>fill</label></td>
		    <td class="centred"><input id="fill_colour" type="color"></input></td>
		    <td class="centred"><input id="rnd_fill_colour" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="fill_colour_off" class="cb" type="checkbox"></input></td>
		  </tr>
		  <tr>
		    <td><label>outline</label></td>
		    <td class="centred"><input id="outline_col" type="color"></input></td>
		    <td class="centred"><input id="rnd_outline_col" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="outline_col_off" class="cb" type="checkbox"></input></td>
		  </tr>
		  <tr>
		    <td><label>line</label></td>
		    <td class="centred"><input id="line_colour" type="color"></input></td>
		    <td class="centred"><input id="rnd_line_colour" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="line_colour_off" class="cb" type="checkbox"></input></td>
		  </tr>
		  <tr>
		    <td><label>trace fill</label></td>
		    <td class="centred"><input id="trc_fil_col" type="color"></input></td>
		    <td class="centred"><input id="rnd_trc_fil_col" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="trc_fil_col_off" class="cb" type="checkbox" disabled></input></td>
		  </tr>
		  <tr>
		    <td><label>trace outl.</label></td>
		    <td class="centred"><input id="trc_oli_col" type="color"></input></td>
		    <td class="centred"><input id="rnd_trc_oli_col" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="trc_oli_col_off" class="cb" type="checkbox" disabled></input></td>
		  </tr>
		  <tr>
		    <td><label>trace line</label></td>
		    <td class="centred"><input id="trc_lin_col" type="color"></input></td>
		    <td class="centred"><input id="rnd_trc_lin_col" class="cb" type="checkbox"></input></td>
		    <td class="centred"><input id="trc_lin_col_off" class="cb" type="checkbox" disabled></input></td>
		  </tr>
		</table>
	      </td>
	    </tr>
	    <tr>
	      <td><label>Tracing:</label></td>
	      <td><input id="cb_tracing" class="cb" type="checkbox" checked></input></td>
	      <!-- <td><input type="button" class="button1" id="btn_reset" onClick="reset_values();" value="Reset Values" disabled></td> -->
	    </tr>
	    <tr>
	      <td><label>Output file:</label></td>
	      <td><input type="text" class="button1" id="out_fn" value="settings.json" /></label></td>
	    </tr>
	    <tr>
	      <td><input type="button" class="button1" id="btn_clear" onClick="clear_canvas();" value="Clear Canvas" /></td>
	      <td><input type="button" class="button1" id="btn_store" onClick="save_settings('out_fn');" value="Save Settings" /></td>
	    </tr>
	    <tr>
	      <td><input type="button" class="button1" id="btn_pause_conti" value="Pause" /></td>
	      <td><input type="button" class="button1" id="btn_start" onClick="restart()" value="Restart" /></td>
	    </tr>
	    <tr>
	      <td colspan="2"><input type="file" id="infilename"></td>
	    </tr>
	    <tr>
	      
	    </tr>
	    <tr><td colspan="2" class="centred"><label>Physics Parameters</label></td></tr>
	    <tr>
	      <td colspan="2">
		<table>
		  <tr>
		    <td>Max Link Length</td>
		    <td><input type="range" min="0" max="200" value="30" step="10" class="slider" id="slider_link_max_length")></td>
		    <td class="right"><span id="span_link_max_length">30</span></td>
		  </tr>
		  <tr>
		    <td>Min Link Length</td>
		    <td><input type="range" min="0" max="200" value="20" step="10" class="slider" id="slider_link_min_length")></td>
		    <td class="right"><span id="span_link_min_length">20</span></td>
		  </tr>
		  <tr>
		    <td>Distance Modifier</td>
		    <td><input type="range" min="0" max="600" value="10" step="10" class="slider" id="slider_dist_modifier")></td>
		    <td class="right"><span id="span_dist_modifier">20</span></td>
		  </tr>
		  <tr>
		    <td>Large Distance Divisor</td>
		    <td><input type="range" min="0" max="200" value="40" step="10" class="slider" id="slider_large_dist_div")></td>
		    <td class="right"><span id="span_large_dist_div">40</span></td>
		  </tr>
		  <tr>
		    <td>Small Distance Divisor</td>
		    <td><input type="range" min="0" max="200" value="30" step="10" class="slider" id="slider_small_dist_div")></td>
		    <td class="right"><span id="span_small_dist_div">30</span></td>
		  </tr>
		  <tr>
		    <td>Distance Threshold</td>
		    <td><input type="range" min="0" max="200" value="100" step="10" class="slider" id="slider_dist_threshold")></td>
		    <td class="right"><span id="span_dist_threshold">100</span></td>
		  </tr>
		</table>
	      </td>
	    </tr>
	    <tr><td colspan="2" class="centred"><label>How to build graph?</label></td></tr>
	    <tr>
	      <td colspan="2"><select class="button2" id="sel_graphalgs" onchange="proc_sel_graphalg('sel_graphalgs')">
		  <option value="0" selected>Random:Random</option>
		  <option value="1">Serial:Random</option>
		  <option value="2">All:All</option>
		  <option value="3">Tree</option>
		  <option value="4">from Edge List</option>
		  <option value="5">Circular</option>
		  <option value="6">Central</option>
		  <option value="7">Linear</option>
		  <option value="8">Ladder</option>
		  <option value="9">Matrix</option>
	      </select></td>
	    </tr>
	    <tr>
	      <td><input type="button" class="button1" id="btn_print" onClick="print_edges(area_edgelist);" value="Print Edges" /></td>
	      <td><input type="button" class="button1" id="btn_rm_lone" onClick="remove_unconnected();" value="Rem Lone Nodes" /></td>
	    </tr>
	    <tr>
	      <td colspan="2" class="centred"><textarea id="edge_list" rows="10" cols="41"></textarea>
	    </tr>
	  </table>
	</div>
	<div class="column" id="canvas_space"><canvas id="cv_canv" onclick="pause_or_continue(btn_pause_conti)" ondblclick="clear_canvas()"></canvas></div>
      </div>
      <script type="text/javascript">
	const canv = document.getElementById("cv_canv")
	const c2d = canv.getContext("2d");
	const inp_vals = {
	    sz_canvas: 1000,
	    nu_nodes:   100,
	    sz_radius:    5,
	    nu_edges:   100,
	    wd_line:      1,
	    nu_branches:  2,
	    nu_scatter:   80,
	    nu_alpha:     90,
	}
	function update_alpha(alpha_value) {
	    update_global_alpha(Math.abs(Number(alpha_value)) / 100);
	}
	const inp_vals_map = {};
	for (let a_val in inp_vals) {
	    inp_vals_map[a_val] = document.getElementById(a_val);
	    inp_vals_map[a_val].value = inp_vals[a_val];
	}
	inp_vals_map.sz_canvas.addEventListener("change",function() {resize_canvas(this.value);});
	inp_vals_map.sz_radius.addEventListener("change",function() {resize_nodes(Number(this.value));});
	inp_vals_map.wd_line.addEventListener("change",function() {resize_linewidth(Number(this.value));});
	inp_vals_map.nu_scatter.addEventListener("change",function(){update_scatter(this.value)});
	inp_vals_map.nu_alpha.addEventListener("change",function(){update_alpha(this.value)});

	function save_to_inp_vals() {
	    for (let a_val in inp_vals)
		 inp_vals[a_val] = inp_vals_map[a_val].value;
	}
	
	const tracer = document.getElementById("cb_tracing");
	tracer.addEventListener("change",function() { check_tracer(); });

	const btn_start = document.getElementById("btn_start");
	const btn_pause_conti = document.getElementById("btn_pause_conti");
	btn_pause_conti.addEventListener("click",function(){
	    pause_or_continue(this);
	});
	const btn_print = document.getElementById("btn_print");
	const btn_clear = document.getElementById("btn_clear");
	const btn_rm_lone = document.getElementById("btn_rm_lone");
	const col_sels = {};
	const rnd_boxes = {};
	const off_boxes = {};
	for (let a_key in colours) {
	    col_sels[a_key] = document.getElementById(a_key);
	    rnd_boxes[a_key] = document.getElementById("rnd_" + a_key);
	    rnd_boxes[a_key].addEventListener("change",function(){col_sel_change(a_key);});
	    off_boxes[a_key] = document.getElementById(a_key + "_off");
	    off_boxes[a_key].addEventListener("change",function(){col_off_change(a_key);});
	}

	const map_node_params = {};
	for (let it in node_params) {
	    map_node_params[it] = [];
	    map_node_params[it].push(document.getElementById("slider_"+it));
	    map_node_params[it].push(document.getElementById("span_"+it));
	    map_node_params[it][0].oninput = function() {
		modify_params(it,Number(this.value));
		map_node_params[it][1].innerHTML = this.value;
	    }
	}
	function restart() {
	    if (btn_pause_conti.value == "Continue")
		pause_or_continue(btn_pause_conti);
	    start(c2d,
		  Number(inp_vals_map.nu_nodes.value),
		  Number(inp_vals_map.nu_edges.value),
		  Number(inp_vals_map.nu_branches.value),
		  Number(inp_vals_map.sz_radius.value),
		  Number(inp_vals_map.nu_alpha.value)
		 );
	}
	function load_cols(cols) {
	    for(a_col in cols) {
		colours[a_col] = cols[a_col];
		col_sels[a_col].value = cols[a_col];
	    }
	}
	const infn = document.getElementById("infilename");
	const freader = new FileReader();
	freader.onload = function( ev ) {
	    const contents = JSON.parse( decodeURIComponent( ev.target.result ) );
	    //console.log(contents);
	    infn.value = "";
	    for(let a_key in inp_vals)
		inp_vals_map[a_key].value = contents.inp_vals[a_key];
	    load_cols(contents.colours);
	    for(let a_key in node_params) {
		node_params[a_key] = contents.node_params[a_key];
		map_node_params[a_key][0].value = contents.node_params[a_key];
	    }
	    config();
	    restart();
	};
	// when it changes (ie: user selects a file)
	infn.addEventListener("change", function() {
	    // get the file item from the input field
	    const file = this.files[0];
	    // read the file as text
	    freader.readAsText( file );
	    // and then then load event will trigger ...
	});
	function pause_or_continue(btn) {
	    if (btn.value == "Pause") {
		pause();
		btn.value = "Continue";
	    } else {
		go_on();
		btn.value = "Pause";
	    }	    
	}
	for (let it in col_sels)
	    col_sels[it].addEventListener("change",function(){colours[it] = col_sels[it].value;});

	const area_edgelist = document.getElementById("edge_list");
	area_edgelist.placeholder = "n1 n2\nn2 n3\nn3 n1";

	function save_settings(fn_id) {
	    const fn = document.getElementById(fn_id).value;
	    let hiddenElement = document.createElement('a');
	    const out_val = {};
	    save_to_inp_vals();
	    out_val.inp_vals = inp_vals;
	    out_val.colours = colours;
	    out_val.node_params = node_params;
	    
	    hiddenElement.href = 'data:attachment/text,' + encodeURIComponent(JSON.stringify(out_val));
	    hiddenElement.target = '_blank';
	    hiddenElement.download = fn;
	    hiddenElement.click();
	}

	document.addEventListener('keydown', (event) => {
	    const keyName = event.key;
	    //console.log(keyName);
	    if (event.ctrlKey && keyName == 'Enter')
		btn_start.dispatchEvent(new Event("click"));
	    if (keyName == 'Pause') {
		pause_or_continue(btn_pause_conti);
	    }
	    if (event.ctrlKey && event.altKey && event.key == 'c')
		btn_clear.dispatchEvent(new Event("click"));
	    if (event.ctrlKey && event.altKey &&  keyName == 'p')
		btn_print.dispatchEvent(new Event("click"));
	    if (event.ctrlKey && event.altKey && event.key == 'r')
		btn_rm_lone.dispatchEvent(new Event("click"));
	    if (event.ctrlKey && event.altKey && event.key == 't') {
		if(tracer.checked)
		    tracer.checked = false;
		else
		    tracer.checked = true;
		tracer.dispatchEvent(new Event("change"));
	    }
	}, false);
      </script>
    </body>
</html>
